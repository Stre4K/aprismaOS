name: AprismaOS Build Matrix

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-matrix:
    strategy:
      matrix:
        os: [macos-latest, docker]
    runs-on: ${{ matrix.os == 'docker' && 'ubuntu-latest' || matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up macOS build environment
        if: matrix.os == 'macos-latest'
        run: |
          echo "Installing dependencies for macOS"
          brew update
          brew install make xorriso qemu i686-elf-binutils i686-elf-gcc i686-elf-ld i686-elf-grub

      - name: Build AprismaOS on macOS
        if: matrix.os == 'macos-latest'
        run: ./aprisma.sh --build iso --homebrew-grub

      - name: Build AprismaOS inside Docker
        if: matrix.os == 'docker'
        run: |
          docker pull stre4k/aprismaos-toolchain:latest
          docker run --rm -v $PWD:/workspace -w /workspace stre4k/aprismaos-toolchain:latest ./aprisma.sh --build iso

